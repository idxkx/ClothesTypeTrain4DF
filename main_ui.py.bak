# Placeholder for Streamlit UI code 

import streamlit as st
import torch
import os
import time
import pandas as pd
import math
import traceback
import json
import asyncio
import nest_asyncio
import platform
import subprocess
import uuid
from datetime import datetime, timedelta
from torchvision import transforms

# --- ç»„ä»¶å¯¼å…¥ ---
from components.config_panel import create_config_panel
from components.training_panel import start_training_process, update_training_ui
from components.history_viewer import display_history, render_action_buttons
from components.gpu_monitor import update_gpu_info, initialize_gpu
from components.metadata_manager import display_metadata_viewer, display_metadata_creator
from components.report_generator import batch_generate_metadata
from utils.state_manager import initialize_session_state
from utils.file_utils import safe_path, load_results, save_results
from utils.time_utils import format_time_delta
from utils.path_manager import load_config_paths

# --- ç¯å¢ƒæ£€æµ‹ ---
IS_WINDOWS = platform.system().lower().startswith('win')
IS_LINUX = platform.system().lower() == 'linux'

# --- äº‹ä»¶å¾ªç¯å¤„ç† ---
try:
    if IS_LINUX:
        nest_asyncio.apply()
    loop = asyncio.get_event_loop()
except RuntimeError:
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)

# --- é…ç½®æ–‡ä»¶å¸¸é‡ ---
RESULTS_FILE = "training_results.json"
CONFIG_PATH = os.path.join(os.path.dirname(__file__), 'config.json')

# --- GPUåˆå§‹åŒ– ---
nvml_available, pynvml, gpu_names = initialize_gpu()

# --- è·¯å¾„é…ç½® ---
ANNO_DIR, IMG_DIR = load_config_paths(CONFIG_PATH)

# --- æ¨¡å‹å’Œè®­ç»ƒå™¨å¯¼å…¥ ---
try:
    from model import ClothesModel
    from trainer import Trainer
    from dataset import DeepFashionDataset
except ImportError as e:
    st.error(f"é”™è¯¯ï¼šæ— æ³•å¯¼å…¥å¿…è¦çš„æ¨¡å—ã€‚è¯·ç¡®ä¿ model.py, trainer.py, dataset.py ä¸ main_ui.py åœ¨åŒä¸€ç›®å½•ä¸‹ã€‚é”™è¯¯: {e}")
    st.stop()

def main():
    """ä¸»åº”ç”¨å…¥å£å‡½æ•°"""
    # --- é¡µé¢é…ç½® ---
    st.set_page_config(page_title="å–µæ­æœè£…è¯†åˆ«è®­ç»ƒåœº", layout="wide")
    st.title("ğŸ‘•å–µæ­ğŸ‘—æœè£…è¯†åˆ«æ¨¡å‹è®­ç»ƒåœº")
    st.markdown("--- ")
    
    # --- åˆå§‹åŒ–ä¼šè¯çŠ¶æ€ ---
    initialize_session_state()
    
    # --- åˆ›å»ºä¾§è¾¹æ é…ç½®é¢æ¿ ---
    selected_device, selected_gpu_index, training_params = create_config_panel(
        ANNO_DIR, IMG_DIR, CONFIG_PATH, nvml_available, gpu_names)
    
    # --- åˆ›å»ºä¸»ç•Œé¢ ---
    col_main_1, col_main_2 = st.columns([2, 1])  # çŠ¶æ€/å›¾è¡¨åŒº vs æ—¥å¿—åŒº
    
    with col_main_1:
        st.subheader("ğŸ“Š è®­ç»ƒçŠ¶æ€ä¸æŒ‡æ ‡")
        status_placeholder = st.empty()
        overall_progress_bar = st.progress(0.0)
        epoch_info_placeholder = st.empty()
        time_info_placeholder = st.empty()
        diagnostic_report_placeholder = st.empty()
        functional_test_placeholder = st.empty()
        loss_chart_placeholder = st.empty()
        acc_chart_placeholder = st.empty()
    
    with col_main_2:
        st.subheader("ğŸ“œ è®­ç»ƒæ—¥å¿—")
        log_placeholder = st.empty()
        log_placeholder.code("", language='log')
    
    # --- åˆ›å»ºGPUç›‘æ§åŒºåŸŸ ---
    st.sidebar.markdown("--- ")
    st.sidebar.subheader("ğŸ“ˆ GPU ç›‘æ§")
    gpu_info_placeholder = st.sidebar.empty()
    gpu_util_chart_placeholder = st.sidebar.empty()
    gpu_mem_chart_placeholder = st.sidebar.empty()
    
    # æ›´æ–°GPUç›‘æ§
    if selected_gpu_index is not None:
        gpu_chart_placeholders = (gpu_util_chart_placeholder, gpu_mem_chart_placeholder)
        update_gpu_info(selected_gpu_index, gpu_info_placeholder, gpu_chart_placeholders)
    
    # --- è®­ç»ƒæ§åˆ¶ ---
    train_button_col, stop_button_col = st.sidebar.columns(2)
    start_training = train_button_col.button("ğŸš€ å¼€å§‹è®­ç»ƒï¼")
    stop_training = stop_button_col.button("â¹ï¸ åœæ­¢è®­ç»ƒ")
    
    if stop_training:
        st.session_state.stop_requested = True
        st.sidebar.warning("æ”¶åˆ°åœæ­¢è¯·æ±‚...å°†åœ¨å½“å‰è½®æ¬¡ç»“æŸåå°è¯•åœæ­¢ã€‚")
    
    # --- è§¦å‘è®­ç»ƒè¿‡ç¨‹ ---
    if start_training:
        ui_components = {
            'status': status_placeholder,
            'progress': overall_progress_bar,
            'epoch_info': epoch_info_placeholder,
            'time_info': time_info_placeholder,
            'diagnostic': diagnostic_report_placeholder,
            'functional_test': functional_test_placeholder,
            'loss_chart': loss_chart_placeholder,
            'acc_chart': acc_chart_placeholder,
            'log': log_placeholder,
            'gpu_info': gpu_info_placeholder,
            'gpu_charts': (gpu_util_chart_placeholder, gpu_mem_chart_placeholder)
        }
        
        start_training_process(
            training_params,
            selected_device,
            selected_gpu_index,
            ui_components,
            ANNO_DIR,
            IMG_DIR,
            RESULTS_FILE
        )
    elif not st.session_state.get('log_messages'):
        status_placeholder.info("è¯·åœ¨å·¦ä¾§è®¾ç½®å‚æ•°å¹¶ç‚¹å‡» 'å¼€å§‹è®­ç»ƒï¼' æŒ‰é’®ã€‚")
        log_placeholder.code("å°šæœªå¼€å§‹è®­ç»ƒ...", language='log')
    
    # --- å†å²è®°å½•åŒºåŸŸ ---
    st.markdown("--- ")
    st.subheader("ğŸ“œ å†å²è®­ç»ƒå¯¹æ¯”")
    
    col1, col2 = st.columns([2, 1])
    with col1:
        if st.button("ğŸ”„ æ‰¹é‡ç”Ÿæˆç¼ºå¤±çš„å…ƒæ•°æ®", key="batch_generate_metadata_btn"):
            with st.spinner("æ­£åœ¨ç”Ÿæˆå…ƒæ•°æ®..."):
                results = batch_generate_metadata()
                st.write("ç”Ÿæˆç»“æœ:")
                for model_name, success, message in results:
                    if success:
                        st.success(f"âœ… {model_name}: {message}")
                    else:
                        st.warning(f"âš ï¸ {model_name}: {message}")
            st.rerun()  # åˆ·æ–°æ˜¾ç¤º
    
    with col2:
        st.session_state.show_failed = st.checkbox(
            "æ˜¾ç¤ºå¤±è´¥çš„è®­ç»ƒ",
            value=True,
            key="show_failed_checkbox",
            help="å‹¾é€‰æ˜¾ç¤ºè®­ç»ƒå¤±è´¥çš„è®°å½•"
        )
    
    # æ˜¾ç¤ºå†å²è®°å½•
    display_history()
    
    # --- å…ƒæ•°æ®æŸ¥çœ‹åŒºåŸŸ ---
    with st.expander("ğŸ” æŸ¥çœ‹æ¨¡å‹å…ƒæ•°æ®", expanded=False):
        display_metadata_viewer()
    
    # --- æ‰‹åŠ¨åˆ›å»ºå…ƒæ•°æ®åŒºåŸŸ ---
    with st.expander("ğŸ› ï¸ æ‰‹åŠ¨åˆ›å»ºå…ƒæ•°æ®", expanded=False):
        display_metadata_creator()

def display_metadata_viewer():
    """æ˜¾ç¤ºå…ƒæ•°æ®æŸ¥çœ‹ç•Œé¢"""
    st.markdown("""
    æ­¤åŒºåŸŸå¯ä»¥æŸ¥çœ‹å·²è®­ç»ƒæ¨¡å‹çš„å…ƒæ•°æ®æ–‡ä»¶ï¼ŒåŒ…å«æ¨¡å‹æ¶æ„ã€ç±»åˆ«åç§°ã€ç‰¹å¾åç§°ç­‰ä¿¡æ¯ã€‚
    """)
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        all_results = load_results()
        model_names = [r.get("model_name", "æœªå‘½åæ¨¡å‹") for r in all_results]
        selected_model = st.selectbox(
            "é€‰æ‹©è¦æŸ¥çœ‹å…ƒæ•°æ®çš„æ¨¡å‹",
            options=model_names,
            index=0 if model_names else None,
            key="metadata_model_select",
            help="é€‰æ‹©ä¸€ä¸ªæ¨¡å‹æ¥æŸ¥çœ‹å…¶å…ƒæ•°æ®å†…å®¹"
        )
    
    with col2:
        if st.button("æŸ¥çœ‹å…ƒæ•°æ®", key="view_metadata_btn"):
            display_model_metadata(selected_model)

def display_metadata_creator():
    """æ˜¾ç¤ºå…ƒæ•°æ®åˆ›å»ºç•Œé¢"""
    st.markdown("""
    æ­¤åŠŸèƒ½å…è®¸ä¸ºå·²è®­ç»ƒçš„æ¨¡å‹æ‰‹åŠ¨åˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶ï¼Œé€‚ç”¨äºå…ƒæ•°æ®ä¸¢å¤±æˆ–æœªè‡ªåŠ¨ç”Ÿæˆçš„æƒ…å†µã€‚
    """)
    
    all_results = load_results()
    model_names = [r.get("model_name", "æœªå‘½åæ¨¡å‹") for r in all_results]
    
    col1, col2 = st.columns([2, 1])
    with col1:
        metadata_model = st.selectbox(
            "é€‰æ‹©è¦åˆ›å»ºå…ƒæ•°æ®çš„æ¨¡å‹",
            options=model_names,
            index=0 if model_names else None,
            key="create_metadata_model_select",
            help="é€‰æ‹©ä¸€ä¸ªæ¨¡å‹æ¥åˆ›å»ºæˆ–é‡æ–°ç”Ÿæˆå…¶å…ƒæ•°æ®æ–‡ä»¶"
        )
    
    if metadata_model:
        create_metadata_form(metadata_model, all_results)

def create_metadata_form(model_name, all_results):
    """ä¸ºæŒ‡å®šæ¨¡å‹åˆ›å»ºå…ƒæ•°æ®è¡¨å•"""
    model_results = [r for r in all_results if r.get("model_name") == model_name]
    if model_results:
        model_result = model_results[0]
        backbone = model_result.get("backbone", "unknown")
        
        st.subheader("åŸºæœ¬ä¿¡æ¯")
        version = st.text_input("ç‰ˆæœ¬", "1.0.0", key="metadata_version")
        description = st.text_input("æè¿°", f"åŸºäº{backbone}çš„æœè£…åˆ†ç±»æ¨¡å‹", key="metadata_description")
        trained_by = st.text_input("è®­ç»ƒè€…", "å–µæ­æœè£…è¯†åˆ«è®­ç»ƒå¹³å°", key="metadata_trained_by")
        date_created = st.date_input("åˆ›å»ºæ—¥æœŸ", datetime.now(), key="metadata_date").strftime("%Y-%m-%d")
        
        st.subheader("æ¨¡å‹é…ç½®")
        st.markdown(f"æ¶æ„: **{backbone}**")
        input_shape = st.text_input("è¾“å…¥å½¢çŠ¶ (é€—å·åˆ†éš”ï¼Œå¦‚3,224,224)", "3,224,224", key="metadata_input_shape")
        
        st.subheader("ç±»åˆ«ä¸ç‰¹å¾")
        st.markdown("### ç±»åˆ«åç§°")
        st.markdown("æ¯è¡Œè¾“å…¥ä¸€ä¸ªç±»åˆ«åç§°ï¼Œå¦‚ä¸ºç©ºå°†ä½¿ç”¨é»˜è®¤åç§°")
        default_class_names = (
            "Tæ¤\nè¡¬è¡«\nå«è¡£\næ¯›è¡£\nè¥¿è£…\nå¤¹å…‹\nç¾½ç»’æœ\né£è¡£\n"
            "ç‰›ä»”è£¤\nä¼‘é—²è£¤\nè¥¿è£¤\nçŸ­è£¤\nè¿åŠ¨è£¤\nè¿è¡£è£™\nåŠèº«è£™\n"
            "æ——è¢\nç¤¼æœ\nè¿åŠ¨é‹\nçš®é‹\né«˜è·Ÿé‹\né´å­\nå‡‰é‹\næ‹–é‹\n"
            "å¸½å­\nå›´å·¾\né¢†å¸¦\næ‰‹å¥—\nè¢œå­\nè…°å¸¦\nçœ¼é•œ\næ‰‹è¡¨\n"
            "é¡¹é“¾\næ‰‹é“¾\nè€³ç¯\næˆ’æŒ‡\nåŒ…åŒ…\nèƒŒåŒ…\næ‰‹æåŒ…\né’±åŒ…\nè¡Œæç®±"
        )
        class_names_text = st.text_area("ç±»åˆ«åç§°åˆ—è¡¨", default_class_names, height=200, key="metadata_class_names")
        
        st.markdown("### ç‰¹å¾åç§°")
        st.markdown("æ¯è¡Œè¾“å…¥ä¸€ä¸ªç‰¹å¾åç§°ï¼Œå¦‚ä¸ºç©ºå°†ä½¿ç”¨é»˜è®¤åç§°")
        default_feature_names = (
            "é¢œè‰²\næè´¨\næ ·å¼\nèŠ±çº¹\nå­£èŠ‚\næ­£å¼åº¦\né¢†å‹\nè¢–é•¿\n"
            "é•¿åº¦\nè£¤å‹\né‹å‹\né«˜åº¦\né—­åˆæ–¹å¼"
        )
        feature_names_text = st.text_area("ç‰¹å¾åç§°åˆ—è¡¨", default_feature_names, height=150, key="metadata_feature_names")
        
        if st.button("åˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶", key="create_metadata_file_btn"):
            # è°ƒç”¨å…ƒæ•°æ®åˆ›å»ºå‡½æ•°
            # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å®ç°create_metadata_fileå‡½æ•°
            pass
    else:
        st.warning(f"æ‰¾ä¸åˆ°æ¨¡å‹ {model_name} çš„è®­ç»ƒè®°å½•")

def display_model_metadata(model_name):
    """æ˜¾ç¤ºæŒ‡å®šæ¨¡å‹çš„å…ƒæ•°æ®"""
    if not model_name:
        st.info("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹")
        return
        
    # æŸ¥æ‰¾é€‰å®šæ¨¡å‹çš„è®°å½•
    model_results = [r for r in load_results() if r.get("model_name") == model_name]
    if not model_results:
        st.warning(f"âš ï¸ æ‰¾ä¸åˆ° {model_name} çš„è®­ç»ƒè®°å½•")
        return
        
    model_result = model_results[0]
    model_path = model_result.get("best_model_path", "")
    
    if not model_path or not os.path.exists(model_path):
        st.warning(f"âš ï¸ æ‰¾ä¸åˆ° {model_name} çš„æ¨¡å‹æ–‡ä»¶")
        return
        
    model_dir = os.path.dirname(model_path)
    metadata_file = os.path.join(model_dir, f"{model_name}_metadata.json")
    
    if not os.path.exists(metadata_file):
        st.warning(f"âš ï¸ æœªæ‰¾åˆ° {model_name} çš„å…ƒæ•°æ®æ–‡ä»¶ ({metadata_file})")
        return
        
    try:
        with open(metadata_file, 'r', encoding='utf-8') as f:
            metadata = json.load(f)
        st.json(metadata)
        st.success(f"âœ… å·²æˆåŠŸåŠ è½½ {model_name} çš„å…ƒæ•°æ®")
    except Exception as e:
        st.error(f"è¯»å–å…ƒæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: {e}")

if __name__ == "__main__":
    main()