# Placeholder for Streamlit UI code 

import sys
import os

# é¢„åˆå§‹åŒ–asyncioäº‹ä»¶å¾ªç¯ï¼Œé¿å…PyTorchä¸Streamlitçš„å¼‚æ­¥å†²çª
import asyncio
import warnings

# å¿½ç•¥PyTorchç›¸å…³çš„ç‰¹å®šè­¦å‘Š
warnings.filterwarnings("ignore", message=".*torch.classes.__path__._path.*")
warnings.filterwarnings("ignore", message=".*Tried to instantiate class '__path__._path'.*")

# å°è¯•åˆå§‹åŒ–asyncioäº‹ä»¶å¾ªç¯
try:
    # å°è¯•è·å–å½“å‰äº‹ä»¶å¾ªç¯
    loop = asyncio.get_event_loop()
except RuntimeError:
    # å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰äº‹ä»¶å¾ªç¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)

# æ·»åŠ å½“å‰ç›®å½•åˆ°Pythonæ¨¡å—æœç´¢è·¯å¾„ä¸­
current_dir = os.path.dirname(os.path.abspath(__file__))
if current_dir not in sys.path:
    sys.path.insert(0, current_dir)

# é¢„åˆå§‹åŒ–asyncioäº‹ä»¶å¾ªç¯ï¼Œé¿å…PyTorchä¸Streamlitçš„å†²çª
import asyncio

# --- äº‹ä»¶å¾ªç¯å¤„ç† ---
try:
    # å…ˆåº”ç”¨nest_asyncioä»¥å…è®¸åµŒå¥—äº‹ä»¶å¾ªç¯
    nest_asyncio.apply()
    # å°è¯•è·å–å½“å‰äº‹ä»¶å¾ªç¯
    loop = asyncio.get_event_loop()
except RuntimeError:
    # å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰äº‹ä»¶å¾ªç¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)

# å¿½ç•¥PyTorchä¸Streamlitä¹‹é—´çš„ç‰¹å®šè­¦å‘Š
import warnings
warnings.filterwarnings("ignore", message="torch.classes.__path__._path")

import streamlit as st
import torch
import time
import pandas as pd
import math
import traceback
import json
import nest_asyncio
import platform
import subprocess
import uuid
from datetime import datetime, timedelta
from torchvision import transforms

# --- ç»„ä»¶å¯¼å…¥ ---
from components.config_panel import create_config_panel
from components.training_panel import start_training_process, update_training_ui
from components.history_viewer import display_history, render_action_buttons
from components.gpu_monitor import update_gpu_info, initialize_gpu
from components.metadata_manager import display_metadata_viewer, display_metadata_creator
from components.report_generator import batch_generate_metadata
from utils.state_manager import initialize_session_state
from utils.file_utils import safe_path, load_results, save_results
from utils.time_utils import format_time_delta
from utils.path_manager import load_config_paths

# --- ç¯å¢ƒæ£€æµ‹ ---
IS_WINDOWS = platform.system().lower().startswith('win')
IS_LINUX = platform.system().lower() == 'linux'

# --- é…ç½®æ–‡ä»¶å¸¸é‡ ---
RESULTS_FILE = "training_results.json"
CONFIG_PATH = os.path.join(os.path.dirname(__file__), 'config.json')

# --- GPUåˆå§‹åŒ– ---
nvml_available, pynvml, gpu_names = initialize_gpu()

# --- è·¯å¾„é…ç½® ---
ANNO_DIR, IMG_DIR = load_config_paths(CONFIG_PATH)

# --- æ¨¡å‹å’Œè®­ç»ƒå™¨å¯¼å…¥ ---
try:
    from model import ClothesModel
    from trainer import Trainer
    from dataset import DeepFashionDataset
except ImportError as e:
    st.error(f"é”™è¯¯ï¼šæ— æ³•å¯¼å…¥å¿…è¦çš„æ¨¡å—ã€‚è¯·ç¡®ä¿ model.py, trainer.py, dataset.py ä¸ main_ui.py åœ¨åŒä¸€ç›®å½•ä¸‹ã€‚é”™è¯¯: {e}")
    st.stop()

def main():
    """ä¸»åº”ç”¨å…¥å£å‡½æ•°"""
    # --- é¡µé¢é…ç½® ---
    st.set_page_config(page_title="å–µæ­æœè£…è¯†åˆ«è®­ç»ƒåœº", layout="wide")
    st.title("ğŸ‘•å–µæ­ğŸ‘—æœè£…è¯†åˆ«æ¨¡å‹è®­ç»ƒåœº")
    st.markdown("--- ")
    
    # --- åˆå§‹åŒ–ä¼šè¯çŠ¶æ€ ---
    initialize_session_state()
    
    # --- åˆ›å»ºä¾§è¾¹æ é…ç½®é¢æ¿ ---
    selected_device, selected_gpu_index, training_params = create_config_panel(
        ANNO_DIR, IMG_DIR, CONFIG_PATH, nvml_available, gpu_names)
    
    # --- åˆ›å»ºä¸»ç•Œé¢ ---
    col_main_1, col_main_2 = st.columns([2, 1])  # çŠ¶æ€/å›¾è¡¨åŒº vs æ—¥å¿—åŒº
    
    with col_main_1:
        st.subheader("ğŸ“Š è®­ç»ƒçŠ¶æ€ä¸æŒ‡æ ‡")
        status_placeholder = st.empty()
        overall_progress_bar = st.progress(0.0)
        epoch_info_placeholder = st.empty()
        time_info_placeholder = st.empty()
        diagnostic_report_placeholder = st.empty()
        functional_test_placeholder = st.empty()
        loss_chart_placeholder = st.empty()
        acc_chart_placeholder = st.empty()
    
    with col_main_2:
        st.subheader("ğŸ“œ è®­ç»ƒæ—¥å¿—")
        log_placeholder = st.empty()
        log_placeholder.code("", language='log')
    
    # --- åˆ›å»ºGPUç›‘æ§åŒºåŸŸ ---
    st.sidebar.markdown("--- ")
    st.sidebar.subheader("ğŸ“ˆ GPU ç›‘æ§")
    gpu_info_placeholder = st.sidebar.empty()
    gpu_util_chart_placeholder = st.sidebar.empty()
    gpu_mem_chart_placeholder = st.sidebar.empty()
    
    # æ›´æ–°GPUç›‘æ§
    if selected_gpu_index is not None:
        gpu_chart_placeholders = (gpu_util_chart_placeholder, gpu_mem_chart_placeholder)
        update_gpu_info(selected_gpu_index, gpu_info_placeholder, gpu_chart_placeholders)
    
    # --- è®­ç»ƒæ§åˆ¶ ---
    train_button_col, stop_button_col = st.sidebar.columns(2)
    start_training = train_button_col.button("ğŸš€ å¼€å§‹è®­ç»ƒï¼")
    stop_training = stop_button_col.button("â¹ï¸ åœæ­¢è®­ç»ƒ")
    
    if stop_training:
        st.session_state.stop_requested = True
        st.sidebar.warning("æ”¶åˆ°åœæ­¢è¯·æ±‚...å°†åœ¨å½“å‰è½®æ¬¡ç»“æŸåå°è¯•åœæ­¢ã€‚")
    
    # --- è§¦å‘è®­ç»ƒè¿‡ç¨‹ ---
    if start_training:
        ui_components = {
            'status': status_placeholder,
            'progress': overall_progress_bar,
            'epoch_info': epoch_info_placeholder,
            'time_info': time_info_placeholder,
            'diagnostic': diagnostic_report_placeholder,
            'functional_test': functional_test_placeholder,
            'loss_chart': loss_chart_placeholder,
            'acc_chart': acc_chart_placeholder,
            'log': log_placeholder,
            'gpu_info': gpu_info_placeholder,
            'gpu_charts': (gpu_util_chart_placeholder, gpu_mem_chart_placeholder)
        }
        
        start_training_process(
            training_params,
            selected_device,
            selected_gpu_index,
            ui_components,
            ANNO_DIR,
            IMG_DIR,
            RESULTS_FILE
        )
    elif not st.session_state.get('log_messages'):
        status_placeholder.info("è¯·åœ¨å·¦ä¾§è®¾ç½®å‚æ•°å¹¶ç‚¹å‡» 'å¼€å§‹è®­ç»ƒï¼' æŒ‰é’®ã€‚")
        log_placeholder.code("å°šæœªå¼€å§‹è®­ç»ƒ...", language='log')
    
    # --- å†å²è®°å½•åŒºåŸŸ ---
    st.markdown("--- ")
    st.subheader("ğŸ“œ å†å²è®­ç»ƒå¯¹æ¯”")
    
    col1, col2 = st.columns([2, 1])
    with col1:
        if st.button("ğŸ”„ æ‰¹é‡ç”Ÿæˆç¼ºå¤±çš„å…ƒæ•°æ®", key="batch_generate_metadata_btn"):
            with st.spinner("æ­£åœ¨ç”Ÿæˆå…ƒæ•°æ®..."):
                results = batch_generate_metadata()
                st.write("ç”Ÿæˆç»“æœ:")
                for model_name, success, message in results:
                    if success:
                        st.success(f"âœ… {model_name}: {message}")
                    else:
                        st.warning(f"âš ï¸ {model_name}: {message}")
            st.rerun()  # åˆ·æ–°æ˜¾ç¤º
    
    with col2:
        st.session_state.show_failed = st.checkbox(
            "æ˜¾ç¤ºå¤±è´¥çš„è®­ç»ƒ",
            value=True,
            key="show_failed_checkbox",
            help="å‹¾é€‰æ˜¾ç¤ºè®­ç»ƒå¤±è´¥çš„è®°å½•"
        )
    
    # æ˜¾ç¤ºå†å²è®°å½•
    display_history()
    
    # --- å…ƒæ•°æ®æŸ¥çœ‹åŒºåŸŸ ---
    with st.expander("ğŸ” æŸ¥çœ‹æ¨¡å‹å…ƒæ•°æ®", expanded=False):
        display_metadata_viewer()
    
    # --- æ‰‹åŠ¨åˆ›å»ºå…ƒæ•°æ®åŒºåŸŸ ---
    with st.expander("ğŸ› ï¸ æ‰‹åŠ¨åˆ›å»ºå…ƒæ•°æ®", expanded=False):
        display_metadata_creator()

if __name__ == "__main__":
    main()

